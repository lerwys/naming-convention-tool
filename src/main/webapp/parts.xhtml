<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
                template="/WEB-INF/namesTemplate.xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                >
    <ui:define name="content">

        <h:form id="ReqSubForm">
            <!-- =================== Menus      ============================ -->
            <table width="100%" id="filterTable">
                <tr>
                    <td align="left">
                        <div>
                            <h:panelGrid columns="2" >
                                <h:outputText value="Show: "/>
                                <p:selectOneMenu value="#{namePartsController.viewFilter}" id="filterMenu">
                                    <p:ajax listener="#{namePartsController.modifyDisplayView}" event="change" update="namePartsTree reqMenu"  oncomplete="resizePanel()"/>
                                    <f:selectItem itemLabel="Approved and Proposed" itemValue="APPROVED_AND_PROPOSED" />
                                    <f:selectItem itemLabel="Approved" itemValue="APPROVED" />
                                    <f:selectItem itemLabel="Proposed" itemValue="PROPOSED" />
                                    <f:selectItem itemLabel="Proposed by Me" itemValue="PROPOSED_BY_ME" itemDisabled="#{!userManager.isLoggedIn()}"/>
                                    <f:selectItem itemLabel="Archived" itemValue="ARCHIVED" />
                                </p:selectOneMenu>
                            </h:panelGrid>
                        </div>
                    </td>
                    <td align="right">
                        <p:menuButton value="Actions" id="reqMenu" style="width: 8%">
                            <p:menuitem value="Add" actionListener="#{namePartsController.showAdd()}" title="Add Name" icon="ui-icon-plus" oncomplete="addName.show()" update=":addNameForm:addName" disabled="#{!namePartsController.canAdd()}" rendered="#{userManager.editor}" />
                            <p:menuitem value="Delete" title="Delete Name" icon="ui-icon-trash" update=":DelNameForm:delName" oncomplete="delName.show()" disabled="#{!namePartsController.canDelete()}" rendered="#{userManager.editor}" />
                            <p:menuitem value="Modify" actionListener="#{namePartsController.showModify()}" title="Modify Name" icon="ui-icon-pencil" update=":ModNameForm:modName" oncomplete="modName.show()" disabled="#{!namePartsController.canModify()}" rendered="#{userManager.editor}" />
                            <p:menuitem value="Approve" title="Approve Request" icon="ui-icon-check" update=":ApproveForm" oncomplete="approveRequest.show()" disabled="#{!namePartsController.canApprove()}" rendered="#{userManager.superUser}" />
                            <p:menuitem value="Reject" title="Reject Request" icon="ui-icon-close" update=":RejectForm" oncomplete="rejectRequest.show()" disabled="#{!namePartsController.canCancel()}" rendered="#{userManager.superUser}" />
                            <p:menuitem value="Cancel" title="Cancel changes" icon="ui-icon-close" update=":CancelReqForm:cancelReq" oncomplete="cancelReq.show()" disabled="#{!namePartsController.canCancel()}" rendered="#{userManager.editor and !userManager.superUser}"/>
                            <p:menuitem value="History" title="View History" icon="ui-icon-search" actionListener="#{namePartsController.findHistory()}" update=":ReqSubForm:historyTable" oncomplete="nameDetail.show()" disabled="#{!namePartsController.canShowHistory()}" />
                        </p:menuButton>
                    </td>
                </tr>
            </table>
            <div id="treeTable">
                <p:treeTable id="namePartsTree" value="#{namePartsController.viewRoot}" var="namePart" liveResize="true" selection="#{namePartsController.selectedNodes}" selectionMode="multiple" scrollable="true" scrollWidth="auto" resizableColumns="true" rowStyleClass="#{namePartsController.nameViewClass(namePart)}" style="padding-top:5px;">
                    <p:ajax event="select" update=":ReqSubForm:reqMenu" />
                    <p:ajax event="unselect" update=":ReqSubForm:reqMenu" />

                    <p:column id="nameDesc" headerText="Name">
                        <h:outputText value="#{namePartsController.getNewName(namePart)}" styleClass="#{namePartsController.getNameClass(namePart,true)}"/>
                        <h:outputText value=" " rendered="#{namePartsController.isModified(namePart,true)}" />
                        <h:outputText value="(#{namePart.name})" styleClass="#{namePartsController.getNameClass(namePart,true)}-Old" rendered="#{namePartsController.isModified(namePart,true)}" />
                    </p:column>
                    <p:column id="nameCode" headerText="Mnemonic" style="width: 10%">
                        <h:outputText value="#{namePartsController.getNewMnemonic(namePart)}" styleClass="#{namePartsController.getNameClass(namePart,false)}-New" />
                        <h:outputText value=" " rendered="#{namePartsController.isModified(namePart,false)}" />
                        <h:outputText value="(#{namePart.mnemonic})" styleClass="#{namePartsController.getNameClass(namePart,false)}-Old" rendered="#{namePartsController.isModified(namePart,false)}" />
                    </p:column>
                    <p:column id="status" headerText="Status" style="width: 15%">
                        <h:outputText value="#{namePartsController.nameStatus(namePart.nameEvent)}" styleClass="#{namePartsController.getNameClass(namePart,false)}" />

                        <h:outputLink id="pendingComment" value="#" rendered="#{namePartsController.hasPendingComment(namePart)}">
                            <h:outputText styleClass="ui-icon ui-icon-info" style="display:inline-block; margin-left:10px !important; vertical-align:bottom !important;"/>
                        </h:outputLink>
                        <p:tooltip for="pendingComment">
                            <h:outputText value="#{namePartsController.getPendingComment(namePart)}" style="white-space: pre;" escape="false"/>
                        </p:tooltip>

                    </p:column>

                </p:treeTable>
            </div>
            <ui:include src="/WEB-INF/includes/parts-history.xhtml" >
                <ui:param name="historyHandler" value="#{namePartsController.historyEvents}" />
            </ui:include>
        </h:form>

        <!-- ===================Add Form================================= -->
        <h:form id="addNameForm" >
            <p:dialog id="addName"  widgetVar="addName" modal="true" resizable="false">
                <f:facet name="header">
                    <h:outputText value="Request to Add Name"/>
                </f:facet>
                <p:panelGrid id="grid" columns="2" style="text-align: left">
                    <h:outputLabel for="idesc" value="Name:" />
                    <h:panelGroup>
                        <p:inputText id="idesc" value="#{namePartsController.newDescription}" required="true" requiredMessage="Please enter a name." />
                        <p:watermark for="idesc" value="e.g. Flux Capacitor" />
                        <p:message for="idesc" />
                    </h:panelGroup>

                    <h:outputLabel for="icode" value="Mnemonic:" />
                    <h:panelGroup>
                        <p:inputText id="icode" value="#{namePartsController.newCode}" required="true" requiredMessage="Please enter a mnemonic." />
                        <p:watermark for="icode" value="e.g. FluxC" />
                        <p:message for="icode" />
                    </h:panelGroup>

                    <h:outputLabel for="icomm" value="Comment (optional):" />
                    <h:panelGroup>
                        <p:inputTextarea id="icomm" rows="5" cols="60" counter="icounter" maxlength="254" value="#{namePartsController.newComment}" counterTemplate="{0} characters remaining." autoResize="false"/>
                        <br/>
                        <h:outputText id="icounter" />
                    </h:panelGroup>
                </p:panelGrid>

                <p:separator />

                <p:commandButton value="Submit" style="float: left" update="grid :ReqSubForm" oncomplete="if (args &amp;&amp; !args.validationFailed) addName.hide(); resizePanel()" action="#{namePartsController.onAdd()}" />
                <p:commandButton value="Cancel" style="float: right" onclick="addName.hide()"  />
            </p:dialog>
        </h:form>

        <!-- ===================Modify Form================================= -->
        <h:form id="ModNameForm" >
            <p:dialog id="modName" widgetVar="modName" modal="true" resizable="false">
                <f:facet name="header">
                    <h:outputText value="Request to Change Name"/>
                </f:facet>
                <p:panelGrid id="pgrid" style="text-align: left">
                    <f:facet name="header">
                        <p:row>
                            <p:column><h:outputText value="" /></p:column>
                            <p:column><h:outputText value="Current Value" /></p:column>
                            <p:column><h:outputText value="New Value" /></p:column>
                        </p:row>
                    </f:facet>

                    <p:row>
                        <p:column><h:outputLabel for="mdesc" value="Name:" /></p:column>
                        <p:column><h:outputText value="#{namePartsController.selectedName.pendingOrElseCurrentRevision.name}"/></p:column>
                        <p:column>
                            <p:inputText id="mdesc" value="#{namePartsController.newDescription}" required="true" requiredMessage="Please enter a name.">
                                <p:ajax listener="#{namePartsController.checkForChanges()}" event="keyup" update="submitModify" />
                            </p:inputText>
                            <p:message for="mdesc" />
                        </p:column>
                    </p:row>
                    <p:row>
                        <p:column><h:outputLabel for="mcode" value="Mnemonic:" /> </p:column>
                        <p:column><h:outputText value="#{namePartsController.selectedName.pendingOrElseCurrentRevision.mnemonic}" /></p:column>
                        <p:column>
                            <p:inputText id="mcode" value="#{namePartsController.newCode}" required="true" requiredMessage="Please enter a mnemonic.">
                                <p:ajax listener="#{namePartsController.checkForChanges()}" event="keyup" update="submitModify" />
                            </p:inputText>
                            <p:message for="mcode" />
                        </p:column>
                    </p:row>
                    <p:row>
                        <p:column><h:outputLabel for="mcomm" value="Comment (optional):" /></p:column>
                        <p:column colspan="2" >
                            <p:inputTextarea id="mcomm"  counter="mcounter" maxlength="254" value="#{namePartsController.newComment}" rows="5" cols="60" counterTemplate="{0} characters remaining." autoResize="false"/>
                            <br/>
                            <h:outputText id="mcounter" />
                        </p:column>
                    </p:row>

                </p:panelGrid>
                <p:separator />

                <p:commandButton id="submitModify" value="Submit" style="float: left" update="pgrid :ReqSubForm" oncomplete="if (args &amp;&amp; !args.validationFailed) modName.hide(); resizePanel()" disabled="#{namePartsController.canSaveModifications()}" action="#{namePartsController.onModify()}"/>
                <p:commandButton value="Cancel" style="float: right" onclick="modName.hide()" />
            </p:dialog>
        </h:form>

        <!-- ===================Delete Form================================= -->
        <h:form id="DelNameForm">
            <p:dialog id="delName"  widgetVar="delName" modal="true" resizable="false">
                <f:facet name="header">
                    <h:outputText value="Request to Delete/Retire Names"/>
                </f:facet>
                <p:panelGrid id="pgrid" style="text-align: left">
                    <p:row>
                        <p:column colspan="2" rendered="#{namePartsController.canDelete()}">
                            <p:treeTable value="#{namePartsController.deleteView}" var="candidate" liveResize="true" resizableColumns="true"  styleClass="previewTreeTable">
                                <p:column headerText="Name" >
                                    <h:outputText styleClass="#{candidate.affected ? 'Processing Delete-Processing' : ''}" value="#{candidate.data.name}" />
                                </p:column>
                                <p:column headerText="Mnemonic" style="width: 30%">
                                    <h:outputText styleClass="#{candidate.affected ? 'Processing Delete-Processing' : ''}" value="#{candidate.data.mnemonic}" />
                                </p:column>
                            </p:treeTable>
                        </p:column>
                    </p:row>

                    <p:row>
                        <p:column>
                            <h:outputLabel for="dcomm" value="Comment (optional):" />
                        </p:column>
                        <p:column>
                            <p:inputTextarea id="dcomm" rows="5" cols="60" counter="dcounter" maxlength="254" value="#{namePartsController.newComment}" counterTemplate="{0} characters remaining." autoResize="false"/>
                            <br/>
                            <h:outputText id="dcounter" />
                        </p:column>
                    </p:row>
                </p:panelGrid>
                <p:separator />

                <p:commandButton value="Submit" style="float: left" oncomplete="delName.hide();resizePanel()" update=":ReqSubForm" actionListener="#{namePartsController.onDelete()}" />
                <p:commandButton value="Cancel" style="float: right" onclick="delName.hide()"  />
            </p:dialog>
        </h:form>

        <!-- ===================Cancel Form    ============================ -->
        <h:form id="CancelReqForm" >
            <p:dialog id="cancelReq" widgetVar="cancelReq" modal="true" resizable="false">
                <f:facet name="header">
                    <h:outputText value="Cancel request"/>
                </f:facet>
                <p:panelGrid id="pgrid" style="text-align: left">
                    <p:row>
                        <p:column colspan="2">
                            <p:treeTable value="#{namePartsController.cancelView}" var="candidate" liveResize="true" resizableColumns="true" styleClass="previewTreeTable">
                                <p:column headerText="Name" >
                                    <h:outputText styleClass="#{namePartsController.getNameClass(candidate.data,true)}" value="#{namePartsController.getOperationsNewName(candidate)}" />
                                    <h:outputText value=" " rendered="#{namePartsController.isModified(candidate.data,true)}" />
                                    <h:outputText value="(#{candidate.data.name})" styleClass="#{namePartsController.getNameClass(candidate.data,true)}-Old" rendered="#{namePartsController.isModified(candidate.data,true)}" />
                                </p:column>
                                 <p:column headerText="Mnemonic" style="width: 30%">
                                    <h:outputText value="#{namePartsController.getNewMnemonic(candidate.data)}" styleClass="#{namePartsController.getNameClass(candidate.data,false)}-New" />
                                    <h:outputText value=" " rendered="#{namePartsController.isModified(candidate.data,false)}" />
                                    <h:outputText value="(#{candidate.data.mnemonic})" styleClass="#{namePartsController.getNameClass(candidate.data,false)}-Old" rendered="#{namePartsController.isModified(candidate.data,false)}" />
                                </p:column>
                             </p:treeTable>
                        </p:column>
                    </p:row>

                    <p:row>
                        <p:column>
                            <h:outputLabel for="dcomm" value="Comment (optional):" />
                        </p:column>
                        <p:column>
                            <p:inputTextarea id="dcomm" rows="5" cols="60" counter="dcounter" maxlength="254" value="#{namePartsController.newComment}" counterTemplate="{0} characters remaining." autoResize="false"/>
                            <br/>
                            <h:outputText id="dcounter" />
                        </p:column>
                    </p:row>
                </p:panelGrid>
                <p:separator />

                <p:commandButton value="Submit" style="float: left" update=":ReqSubForm" oncomplete="cancelReq.hide();resizePanel()" actionListener="#{namePartsController.onCancel()}"/>
                <p:commandButton value="Cancel" style="float: right" onclick="cancelReq.hide()"  />
            </p:dialog>
        </h:form>

        <!-- ===================    Approve Form    ============================ -->
        <h:form id="ApproveForm" >
            <p:dialog id="approveRequest"  widgetVar="approveRequest" modal="true" resizable="false">
                <f:facet name="header">
                    <h:outputText value="Approve"/>
                </f:facet>
                <p:panelGrid style="text-align: left">
                    <p:row>
                        <p:column colspan="2">
                            <p:treeTable value="#{namePartsController.approveView}" var="candidate" resizableColumns="true" liveResize="true" styleClass="previewTreeTable">
                                <p:column headerText="Name" >
                                    <h:outputText styleClass="#{candidate.affected ? namePartsController.getNameClass(candidate.data,true).concat('-New') : ''}" value="#{namePartsController.getOperationsNewName(candidate)}" />
                                    <h:outputText value=" " rendered="#{namePartsController.isModified(candidate.data,true)}" />
                                    <h:outputText value="(#{candidate.data.name})" styleClass="#{candidate.affected ? namePartsController.getNameClass(candidate.data,true).concat('-Old') : ''}" rendered="#{namePartsController.isModified(candidate.data,true)}" />
                                </p:column>
                                <p:column headerText="Mnemonic" style="width: 30%">
                                    <h:outputText value="#{namePartsController.getNewMnemonic(candidate.data)}" styleClass="#{candidate.affected ? namePartsController.getNameClass(candidate.data,false).concat('-New') : ''}" />
                                    <h:outputText value=" " rendered="#{namePartsController.isModified(candidate.data,false)}" />
                                    <h:outputText value="(#{candidate.data.mnemonic})" styleClass="#{candidate.affected ? namePartsController.getNameClass(candidate.data,false).concat('-Old') : ''}" rendered="#{namePartsController.isModified(candidate.data,false)}" />
                                </p:column>
                            </p:treeTable>
                        </p:column>
                    </p:row>

                    <p:row>
                        <p:column><h:outputLabel for="acomm" value="Comment (optional):" /></p:column>
                        <p:column>
                            <p:inputTextarea id="acomm" rows="5" cols="60" counter="counter" maxlength="254" value="#{namePartsController.newComment}" counterTemplate="{0} characters remaining." autoResize="false"/>
                            <br/>
                            <h:outputText id="counter" />
                        </p:column>
                    </p:row>
                </p:panelGrid>
                <p:separator />

                <p:commandButton value="Approve" style="float: left" update=":ReqSubForm" oncomplete="approveRequest.hide();resizePanel()" actionListener="#{namePartsController.onApprove()}"/>
                <p:commandButton value="Cancel" style="float: right" onclick="approveRequest.hide()" />
            </p:dialog>
        </h:form>

        <h:form id="RejectForm">
            <p:dialog id="rejectRequest"  widgetVar="rejectRequest" modal="true" resizable="false">
                <f:facet name="header">
                    <h:outputText value="Reject"/>
                </f:facet>
                <p:panelGrid style="text-align: left">
                    <p:row>
                        <p:column colspan="2">
                            <p:treeTable value="#{namePartsController.cancelView}" var="candidate" liveResize="true" resizableColumns="true" styleClass="previewTreeTable">
                                <p:column headerText="Name" >
                                    <h:outputText styleClass="#{namePartsController.getNameClass(candidate.data,true)}" value="#{namePartsController.getOperationsNewName(candidate)}" />
                                    <h:outputText value=" " rendered="#{namePartsController.isModified(candidate.data,true)}" />
                                    <h:outputText value="(#{candidate.data.name})" styleClass="#{namePartsController.getNameClass(candidate.data,true)}-Old" rendered="#{namePartsController.isModified(candidate.data,true)}" />
                                </p:column>
                                 <p:column headerText="Mnemonic" style="width: 30%">
                                    <h:outputText value="#{namePartsController.getNewMnemonic(candidate.data)}" styleClass="#{namePartsController.getNameClass(candidate.data,false)}-New" />
                                    <h:outputText value=" " rendered="#{namePartsController.isModified(candidate.data,false)}" />
                                    <h:outputText value="(#{candidate.data.mnemonic})" styleClass="#{namePartsController.getNameClass(candidate.data,false)}-Old" rendered="#{namePartsController.isModified(candidate.data,false)}" />
                                </p:column>
                             </p:treeTable>
                        </p:column>
                    </p:row>

                    <p:row>
                        <p:column><h:outputLabel for="rcomm" value="Comment:" /></p:column>
                        <p:column>
                            <p:inputTextarea id="rcomm" rows="5" cols="70" counter="counter" maxlength="254" value="#{namePartsController.newComment}" counterTemplate="{0} characters remaining." autoResize="false"/>
                            <br/>
                            <h:outputText id="counter" />
                        </p:column>
                    </p:row>
                </p:panelGrid>
                <p:separator />
                <p:commandButton value="Reject" style="float: left" update=":ReqSubForm" oncomplete="rejectRequest.hide(); resizePanel()" action="#{namePartsController.onReject()}"/>
                <p:commandButton value="Cancel" style="float: right" onclick="rejectRequest.hide()" />
            </p:dialog>
        </h:form>
    </ui:define>
</ui:composition>