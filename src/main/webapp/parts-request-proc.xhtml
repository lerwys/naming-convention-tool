<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
                template="/WEB-INF/namesTemplate.xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                >

    <ui:define name="content">
        <h:outputText value="Sorry, you are not authorized to perform this operation." rendered="#{not userManager.superUser}" />
        <h:form id="requestForm" rendered="#{userManager.superUser}">
            <p:panelGrid style="position:fixed" styleClass="noBorders"  rendered="false">
                <p:row>
                    <p:column>
                        <p:commandButton icon="ui-icon-check" onclick="approveRequest.show()" title="Approve"/>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column>
                        <p:commandButton icon="ui-icon-close" onclick="rejectRequest.show()" title="Reject"/>
                    </p:column>
                </p:row>
            </p:panelGrid>
            <p:menu  rendered="true" styleClass="fixedPosition box"  style="width: 7%">
                <p:submenu  label="Process">
                    <p:menuitem value="Approve" icon="ui-icon-check" update=":ApproveForm" oncomplete="approveRequest.show()" title="Approve Request" />
                    <p:menuitem value="Reject"  icon="ui-icon-close" update=":RejectForm" oncomplete="rejectRequest.show()" title="Reject Request" />
                    <p:menuitem value="History" icon="ui-icon-search"  title="View History" actionListener="#{requestProcManager.findHistory()}" update=":requestForm:historyTable" oncomplete="nameDetail.show()" />
                </p:submenu>
            </p:menu>
            <p:contextMenu for="requestTable">
                <p:menuitem value="Approve" icon="ui-icon-check"  onclick="approveRequest.show()" />
                <p:menuitem value="Reject" icon="ui-icon-close"  onclick="rejectRequest.show()" />
                <p:menuitem value="History" icon="ui-icon-search"  actionListener="#{requestProcManager.findHistory()}" update=":requestForm:historyTable" oncomplete="nameDetail.show()" />
            </p:contextMenu>
            <p:dataTable id="requestTable" var="nevent" value="#{requestProcManager.events}"
                         paginator="true" rows="50" resizableColumns="true"
                         rowKey="#{nevent.id}"
                         emptyMessage="There are no pending requests."
                         selection="#{requestProcManager.selectedEvents}"
                         filteredValue="#{requestProcManager.filteredEvents}"
                         style="width: 90%">
                <f:facet name="header">
                    <h:outputText value="Requests to be Processesd" />
                </f:facet>

                <p:column selectionMode="multiple" style="width: 4%" />

                <p:column id="id" headerText="Id" sortBy="#{nevent.id}"  rendered="false" >
                    <h:outputText value="#{nevent.id}" />
                </p:column>
                <p:column id="type" headerText="Type"  >
                    <h:outputText value="#{requestManager.getRequestType(nevent)}" />
                </p:column>
                <p:column id="nameCat" headerText="Category" filterBy="#{nevent.nameCategory}"
                          filterMatchMode="contains"  >
                    <h:outputText value="#{nevent.nameCategory}" />
                </p:column>
                <p:column id="name" headerText="Name" filterBy="#{nevent.name}"
                          filterMatchMode="startsWith"  >
                    <h:outputText value="#{nevent.name}" />
                </p:column>
                <p:column id="fullName" headerText="Full Name" filterBy="#{nevent.fullName}"
                          filterMatchMode="contains" >
                    <h:outputText value="#{nevent.fullName}" />
                </p:column>

                <p:column id="reqBy" headerText="By" sortBy="#{nevent.nameEvent.requestedBy.username}" >
                    <h:outputText value="#{nevent.nameEvent.requestedBy.username}" />
                </p:column>
                <p:column id="reqDate" headerText="Date" sortBy="#{nevent.nameEvent.requestDate}" >
                    <h:outputText value="#{nevent.nameEvent.requestDate}" >
                        <f:convertDateTime pattern="yyyy-MM-dd" />
                    </h:outputText>
                </p:column>
                <p:column id="reqComment" headerText="Comment" >
                    <h:outputText value="#{nevent.nameEvent.requestorComment}" />
                </p:column>
            </p:dataTable>

            <p:growl id="requestMsgs" showDetail="true"/>


            <ui:include src="/WEB-INF/includes/part-history.xhtml" >
                <ui:param name="historyHandler" value="#{requestProcManager.historyEvents}" />
            </ui:include>
        </h:form>

        <h:form id="ApproveForm" >
            <p:dialog id="approveRequest"  widgetVar="approveRequest">
                <f:facet name="header">
                    <h:outputText value="Approve"/>
                </f:facet>
                <p:panelGrid style="text-align: left" >
                    <p:row>
                        <p:column><h:outputLabel for="acomm" value="Approval Comments (optional):" /></p:column>
                        <p:column>
                            <p:inputTextarea id="acomm" rows="5" cols="40" counter="counter" maxlength="254"
                                             value="#{requestProcManager.comments}"
                                             counterTemplate="{0} characters remaining." autoResize="false"/>
                            <br/>
                            <h:outputText id="counter" />
                        </p:column>
                    </p:row>
                </p:panelGrid>
                <p:separator />

                <p:commandButton value="Approve" style="float: left"
                                 update=":requestForm"
                                 oncomplete="approveRequest.hide()"
                                 action="#{requestProcManager.onApprove()}"/>
                <p:commandButton  value="Cancel" style="float: right"
                                  onclick="approveRequest.hide()"  />
            </p:dialog>
        </h:form>

        <h:form id="RejectForm">
            <p:dialog id="rejectRequest"  widgetVar="rejectRequest">
                <f:facet name="header">
                    <h:outputText value="Reject"/>
                </f:facet>
                <p:panelGrid style="text-align: left" >
                    <p:row>
                        <p:column><h:outputLabel for="rcomm" value="Rejection Comments (optional):" /></p:column>
                        <p:column>
                            <p:inputTextarea id="rcomm" rows="5" cols="40" counter="counter" maxlength="254"
                                             value="#{requestProcManager.comments}"
                                             counterTemplate="{0} characters remaining." autoResize="false"/>
                            <br/>
                            <h:outputText id="counter" />
                        </p:column>
                    </p:row>
                </p:panelGrid>
                <p:separator />
                <p:commandButton  value="Reject" style="float: left"
                                  update=":requestForm"
                                  oncomplete="rejectRequest.hide()"
                                  action="#{requestProcManager.onReject()}"/>
                <p:commandButton  value="Cancel" style="float: right"
                                  onclick="rejectRequest.hide()"  />
            </p:dialog>
        </h:form>


    </ui:define>

</ui:composition>