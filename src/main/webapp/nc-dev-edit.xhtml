<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- ToDo: split this one into MyRequests and RequestSub -->

<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
                template="/WEB-INF/namesTemplate.xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:c="http://java.sun.com/jsp/jstl/core">

    <ui:define name="content">
        <h:outputText value="You must be a device editor to perform this action."
                rendered="#{not userManager.editor}" />
        <h:form id="ManageNameForm" rendered="#{userManager.editor}">
            <p:growl id="ncRequestMsgs" showDetail="true" sticky="false"
                    life="30000" />

            <!-- =================== Menus ============================ -->
            <p:menu id="ncReqMenu" styleClass="fixedPosition box"
                    style="width: 8%; z-index: 100;">
                <p:submenu label="Device Names">
                    <p:menuitem value="Add" icon="ui-icon-plus" update=":AddDeviceNameForm"
                            oncomplete="addDeviceName.show()" title="Add Name"
                            rendered="#{userManager.editor}" />
                    <p:menuitem value="Delete" icon="ui-icon-trash"
                            update=":delDeviceNameForm" oncomplete="delDeviceName.show()"
                            title="Delete Device Name" rendered="#{userManager.editor}"
                disabled="#{empty editNamesManager.selectedDeviceName || editNamesManager.selectedDeviceName.status == 'DELETED' || editNamesManager.selectedDeviceName.requestedBy.username != userManager.user.username}" />
                    <p:menuitem value="Modify" icon="ui-icon-pencil"
                            update=":modDeviceNameForm" oncomplete="modDeviceName.show()"
                            action="#{editNamesManager.loadSelectedName()}"
                            title="Modify NC Name" rendered="#{userManager.editor}"
                disabled="#{empty editNamesManager.selectedDeviceName || editNamesManager.selectedDeviceName.requestedBy.username != userManager.user.username}" />
                    <p:menuitem value="History" icon="ui-icon-search"
                            actionListener="#{editNamesManager.loadHistory()}"
                            update=":ManageNameForm:historyTable" title="View History"
                            oncomplete="nameDetail.show()"
                            disabled="#{empty editNamesManager.selectedDeviceName}" />
                    <!-- 	<p:menuitem value="Cancel" icon="ui-icon-close" -->
                    <!-- 		update=":CancelReqForm" oncomplete="cancelReq.show()" -->
                    <!-- 		title="Cancel Request" rendered="#{requestManager.myRequest}" -->
                    <!-- 		disabled="#{requestManager.selectedEventProcessed()}" /> -->
                </p:submenu>
            </p:menu>

            <p:contextMenu id="ncCntxtMenu" for="ncCrTable">
                <p:menuitem value="Add" icon="ui-icon-plus"
                        oncomplete="addDeviceName.show()"
                        rendered="#{userManager.editor}" />
                <p:menuitem value="Delete" update=":delDeviceNameForm"
                        icon="ui-icon-trash" oncomplete="delDeviceName.show()"
                        rendered="#{userManager.editor}"
                        disabled="#{empty editNamesManager.selectedDeviceName || editNamesManager.selectedDeviceName.status == 'DELETED'}" />
                <p:menuitem value="Modify" update=":modDeviceNameForm"
                        action="#{editNamesManager.loadSelectedName()}"
                        icon="ui-icon-pencil" oncomplete="modDeviceName.show()"
                        rendered="#{userManager.editor}"
                        disabled="#{empty editNamesManager.selectedDeviceName}" />
                <p:menuitem value="Approve" icon="ui-icon-star"
                        update="ncCrTable" action="#{editNamesManager.approve()}"
                        rendered="#{userManager.editor}"
                disabled="#{empty editNamesManager.selectedDeviceName || editNamesManager.selectedDeviceName.processDate != null || !editNamesManager.superUser}" />
                <p:menuitem value="History" icon="ui-icon-search"
                        actionListener="#{requestManager.findHistory()}"
                        update=":ManageNameForm:historyTable" oncomplete="nameDetail.show()"
                        disabled="#{empty editNamesManager.selectedDeviceName}" />
<!-- 		<p:menuitem value="Cancel Request" icon="ui-icon-close" -->
<!-- 			update=":CancelReqForm" oncomplete="cancelReq.show()" -->
<!-- 			title="Cancel Request" rendered="#{requestManager.myRequest}" -->
<!-- 			disabled="#{requestManager.selectedEventProcessed()}" /> -->
            </p:contextMenu>

            <!-- ===================Data Table============================ -->
            <p:dataTable id="ncCrTable" var="deviceName" value="#{editNamesManager.allDeviceNames}"
                         paginator="true" rows="50" resizableColumns="true" rowKey="#{deviceName.id}"
                         emptyMessage="There are no NC Names" rowStyleClass="#{deviceName.status}"
                         selection="#{editNamesManager.selectedDeviceName}" style="width: 90%">
                <f:facet name="header">
                    <h:outputText value="Existing Device Names" />
                </f:facet>

                <p:ajax event="rowSelectRadio" update=":ManageNameForm:ncReqMenu :modDeviceNameForm" />
                <p:column selectionMode="single" style="width: 5%" />

                <p:column id="nameString" headerText="Convention Name" filterBy="#{deviceName.conventionName}" filterMatchMode="contains" style="width: 20%">
                    <h:outputText value="#{deviceName.conventionName}" />
                </p:column>
                <p:column id="nameSection" headerText="Section" filterBy="#{deviceName.section.fullName}" filterMatchMode="contains" style="width: 30%">
                    <h:outputText value="#{deviceName.sectionPath}" />
                </p:column>
                <p:column id="nameDeviceType" headerText="Device type" filterBy="#{deviceName.deviceType.fullName}" filterMatchMode="contains" style="width: 30%">
                    <h:outputText value="#{deviceName.deviceTypePath}" />
                </p:column>
                <p:column id="nameQualifier" headerText="Qualifier" filterBy="#{deviceName.qualifier}" filterMatchMode="contains" style="width: 20%">
                    <h:outputText value="#{deviceName.qualifier}" />
                </p:column>
                <p:column id="nameStatus">
                    <f:facet name="header">
                        <h:outputText value="Status" />
                        <br />
                        <p:selectBooleanButton value="#{editNamesManager.showDeletedNames}" onLabel="Deleted" offLabel="Deleted" onIcon="ui-icon-check" offIcon="ui-icon-close">
                            <p:ajax update="ncCrTable"  listener="#{editNamesManager.loadDeviceNames}"/>
                        </p:selectBooleanButton>
                    </f:facet>
                    <h:outputText value="#{deviceName.status}" />
                </p:column>
            </p:dataTable>

            <ui:include src="/WEB-INF/includes/nc-dev-history.xhtml" >
                <ui:param name="historyHandler" value="#{editNamesManager.historyEvents}" />
            </ui:include>

        </h:form>

        <!-- ===================Add Form================================= -->
        <h:form id="AddDeviceNameForm">
            <p:dialog id="addDeviceName" widgetVar="addDeviceName">
                <f:facet name="header">
                        <h:outputText value="Add Naming Convention Name" />
                </f:facet>
                <p:panelGrid style="text-align: left">
                    <p:row>
                        <p:column colspan="${editNamesManager.namePartsCount}">
                            Which part of the facility does the device provide service to?
                        </p:column>
                    </p:row>
                    <p:row>
                        <c:forEach items="#{editNamesManager.sectionLevels}" var="level" varStatus="loop">
                            <p:column style="width: 128px">
                                <p:selectOneMenu id="sectLvl_#{loop.index}" value="#{level.selectedId}">
                                    <p:ajax listener="#{editNamesManager.loadNextSectionLevel(loop.index)}"
                                            update="#{editNamesManager.generateUpdateIds(0, 'sectLvl_', editNamesManager.sectionLevels.size(), 'ibsub')}" />
                                    <f:selectItem itemLabel="Select..." noSelectionOption="true" />
                                    <f:selectItems value="#{level.options}"
                                            var="selItem" itemLabel="#{selItem.fullName}" itemValue="#{selItem.id}" />
                                </p:selectOneMenu>
                            </p:column>
                        </c:forEach>
                        <!-- append empty columns if necessary -->
                        <c:forEach begin="#{editNamesManager.sectionLevels.size() + 1}" end="#{editNamesManager.namePartsCount}" >
                            <p:column style="width: 128px">
                            </p:column>
                        </c:forEach>
                    </p:row>

                    <p:row>
                        <p:column colspan="${editNamesManager.namePartsCount}">
                            What kind of device is it?
                        </p:column>
                    </p:row>
                    <p:row>
                        <c:forEach items="#{editNamesManager.deviceTypeLevels}" var="level" varStatus="loop">
                            <p:column style="width: 128px">
                                <p:selectOneMenu id="devLvl_#{loop.index}" value="#{level.selectedId}">
                                    <p:ajax listener="#{editNamesManager.loadNextDeviceTypeLevel(loop.index)}"
                                            update="#{editNamesManager.generateUpdateIds(0, 'devLvl_', editNamesManager.deviceTypeLevels.size(), 'ibsub')}" />
                                    <f:selectItem itemLabel="Select..." noSelectionOption="true" />
                                    <f:selectItems value="#{level.options}"
                                            var="selItem" itemLabel="#{selItem.fullName}" itemValue="#{selItem.id}" />
                                </p:selectOneMenu>
                            </p:column>
                        </c:forEach>
                        <!-- append empty columns if necessary -->
                        <c:forEach begin="#{editNamesManager.deviceTypeLevels.size() + 1}" end="#{editNamesManager.namePartsCount}" >
                            <p:column style="width: 128px">
                            </p:column>
                        </c:forEach>
                    </p:row>
                </p:panelGrid>
                <h:outputText id="icounter" />
                <p:separator />

                <p:commandButton id="ibsub" value="Submit" style="float: left"
                        update=":ManageNameForm" oncomplete="addDeviceName.hide()"
                        action="#{editNamesManager.onAdd()}"
                        disabled="#{!editNamesManager.isFormFilled()}"/>
                <p:commandButton value="Cancel" style="float: right"
                        onclick="addDeviceName.hide()" />
            </p:dialog>
        </h:form>

        <!-- ===================Modify Form================================= -->
        <h:form id="modDeviceNameForm">
            <p:dialog widgetVar="modDeviceName">
                <f:facet name="header">
                    <h:outputText value="Request to Change Name" />
                </f:facet>
                <p:panelGrid style="text-align: left">
                    <p:row>
                        <p:column colspan="4">
                            Which part of the facility does the device provide service to?
                        </p:column>
                    </p:row>
                    <p:row>
                        <p:column colspan="1">
                            Current values:
                        </p:column>
                        <p:column colspan="3">
                            <h:outputText value="#{editNamesManager.getSelectedDeviceNameSectionString()}" />
                        </p:column>
                    </p:row>
                    <p:row>
                        <c:forEach items="#{editNamesManager.sectionLevels}" var="level" varStatus="loop">
                            <p:column style="width: 128px">
                                <p:selectOneMenu id="sectLvl_#{loop.index}" value="#{level.selectedId}">
                                    <p:ajax listener="#{editNamesManager.loadNextSectionLevel(loop.index)}"
                                            update="#{editNamesManager.generateUpdateIds(0, 'sectLvl_', editNamesManager.sectionLevels.size(), 'mbsub')}" />
                                    <f:selectItem itemLabel="Select..." noSelectionOption="true" />
                                    <f:selectItems value="#{level.options}"
                                            var="selItem" itemLabel="#{selItem.fullName}" itemValue="#{selItem.id}" />
                                </p:selectOneMenu>
                            </p:column>
                        </c:forEach>
                        <!-- append empty columns if necessary -->
                        <c:forEach begin="#{editNamesManager.sectionLevels.size() + 1}" end="#{editNamesManager.namePartsCount}" >
                            <p:column style="width: 128px">
                            </p:column>
                        </c:forEach>
                    </p:row>

                    <p:row>
                        <p:column colspan="4">
                            What kind of device is it?
                        </p:column>
                    </p:row>
                    <p:row>
                        <p:column colspan="1">
                            Current values:
                        </p:column>
                        <p:column colspan="3">
                            <h:outputText value="#{editNamesManager.getSelectedDeviceNameDisciplineString()}" />
                        </p:column>
                    </p:row>
                    <p:row>
                        <c:forEach items="#{editNamesManager.deviceTypeLevels}" var="level" varStatus="loop">
                            <p:column style="width: 128px">
                                <p:selectOneMenu id="devLvl_#{loop.index}" value="#{level.selectedId}">
                                    <p:ajax listener="#{editNamesManager.loadNextDeviceTypeLevel(loop.index)}"
                                            update="#{editNamesManager.generateUpdateIds(0, 'devLvl_', editNamesManager.deviceTypeLevels.size(), 'mbsub')}" />
                                    <f:selectItem itemLabel="Select..." noSelectionOption="true" />
                                    <f:selectItems value="#{level.options}"
                                            var="selItem" itemLabel="#{selItem.fullName}" itemValue="#{selItem.id}" />
                                </p:selectOneMenu>
                            </p:column>
                        </c:forEach>
                        <!-- append empty columns if necessary -->
                        <c:forEach begin="#{editNamesManager.deviceTypeLevels.size() + 1}" end="#{editNamesManager.namePartsCount}" >
                            <p:column style="width: 128px">
                            </p:column>
                        </c:forEach>
                    </p:row>
                </p:panelGrid>
                <p:separator />

                <p:commandButton id="mbsub" value="Submit" style="float: left"
                        update=":ManageNameForm" oncomplete="modDeviceName.hide()"
                        action="#{editNamesManager.onModify()}"
                        disabled="#{!editNamesManager.isFormFilled()}"/>
                <p:commandButton value="Cancel" style="float: right"
                        onclick="modDeviceName.hide()" />
            </p:dialog>
        </h:form>

        <!-- ===================Delete Form================================= -->
        <h:form id="delDeviceNameForm">
            <p:dialog id="delDeviceName" widgetVar="delDeviceName">
                <f:facet name="header">
                    <h:outputText value="Delete/Retire Naming Convention Name" />
                </f:facet>
                <p:panelGrid id="pgrid" style="text-align: left">
                    <p:row>
                        <p:column style="width: 128px">
                            <h:outputText
                                    value="#{editNamesManager.selectedDeviceName.section.fullName}" />
                        </p:column>
                        <p:column style="width: 128px">
                            <h:outputText
                                    value="#{editNamesManager.selectedDeviceName.deviceType.fullName}" />
                        </p:column>
                    </p:row>

                    <p:row>
                        <p:column colspan="4">
                            <h:outputText value="#{editNamesManager.selectedDeviceName.name}" />
                        </p:column>
                    </p:row>
                </p:panelGrid>
                <p:separator />

                <p:commandButton value="Submit" style="float: left"
                        update=":ManageNameForm" oncomplete="delDeviceName.hide()"
                        action="#{editNamesManager.onDelete()}" />
                <p:commandButton value="Cancel" style="float: right"
                        onclick="delDeviceName.hide()" />
            </p:dialog>
        </h:form>

    </ui:define>
</ui:composition>
