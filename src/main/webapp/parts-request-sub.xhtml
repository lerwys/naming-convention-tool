<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- ToDo: split this one into MyRequests and RequestSub -->

<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
                template="/WEB-INF/namesTemplate.xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:fn="http://java.sun.com/jsp/jstl/functions"
                >
    <ui:define name="content">
        <h:outputText value="You must be a device editor to perform this action." rendered="#{not userManager.editor}" />
        <h:form id="ReqSubForm" rendered="#{userManager.editor}">
            <p:growl id="requestMsgs" showDetail="true" sticky="false"  life="30000" />

            <!-- =================== Menus      ============================ -->
            <p:menu id="reqMenu" styleClass="fixedPosition box" style="width: 8%">
                <p:submenu label="Requests">
                    <p:menuitem value="Add" icon="ui-icon-plus" oncomplete="addName.show()"
                                update=":addNameForm :ReqSubForm:namePartsTree" title="Add Name"
                                disabled="#{fn:length(requestManager.selectedNodes) != 1}" />
                    <p:menuitem value="Delete" icon="ui-icon-trash" update=":DelNameForm:delName"
                                oncomplete="delName.show()" title="Delete Name"
                                actionListener="#{requestManager.prepareDeleteView()}"
                                disabled="#{fn:length(requestManager.selectedNodes) lt 1}" />
                    <p:menuitem value="Modify" icon="ui-icon-pencil" update=":ModNameForm:modName"
                                oncomplete="modName.show()" title="Modify Name"
                                disabled="#{fn:length(requestManager.selectedNodes) != 1}" />
                    <p:menuitem value="History" icon="ui-icon-search" actionListener="#{requestManager.findHistory()}"
                                update=":ReqSubForm:historyTable" title="View History" oncomplete="nameDetail.show()"
                                disabled="#{fn:length(requestManager.selectedNodes) != 1}" />
                    <p:menuitem value="Cancel" icon="ui-icon-close" update=":CancelReqForm:cancelReq"
                                oncomplete="cancelReq.show()" title="Cancel Request"
                                disabled="#{requestManager.selectedEventProcessed()}" />
                </p:submenu>
            </p:menu>

            <p:contextMenu id="cntxtMenu" for="namePartsTree">
                <p:menuitem value="Add" icon="ui-icon-plus"  oncomplete="addName.show()"
                            disabled="#{fn:length(requestManager.selectedNodes) != 1}" />
                <p:menuitem value="Delete" update=":DelNameForm" icon="ui-icon-trash"
                            oncomplete="delName.show()"
                            disabled="#{fn:length(requestManager.selectedNodes) lt 1}" />
                <p:menuitem value="Modify" update=":ModNameForm" icon="ui-icon-pencil"
                            oncomplete="modName.show()"
                            disabled="#{fn:length(requestManager.selectedNodes) != 1}" />
                <p:menuitem value="History" icon="ui-icon-search" actionListener="#{requestManager.findHistory()}"
                            update=":ReqSubForm:historyTable" oncomplete="nameDetail.show()"
                            disabled="#{fn:length(requestManager.selectedNodes) != 1}" />
                <p:menuitem value="Cancel Request" icon="ui-icon-close" update=":CancelReqForm"
                            oncomplete="cancelReq.show()" title="Cancel Request"
                            disabled="#{requestManager.selectedEventProcessed()}"/>
            </p:contextMenu>

            <p:treeTable id="namePartsTree" value="#{requestManager.root}" var="namePart"
                         selection="#{requestManager.selectedNodes}" selectionMode="multiple"
                         resizableColumns="true" rowStyleClass="#{namesManager.nameViewClass(namePart)}"
                         style="width: 90%">
                <f:facet name="header">
                    <h:outputText value="Submit Change Request" />
                </f:facet>

                <p:ajax event="select" update=":ReqSubForm:reqMenu :ReqSubForm:cntxtMenu" />
                <p:ajax event="unselect" update=":ReqSubForm:reqMenu :ReqSubForm:cntxtMenu" />

                <p:column id="nameDesc" headerText="Full Name" filterBy="#{namePart.fullName}"
                          filterMatchMode="contains" >
                    <h:outputText value="#{requestManager.getNewFullName(namePart)}"
                                  styleClass="#{requestManager.getNameClass(namePart)}" />
                    <h:outputText value=" " rendered="#{requestManager.isModified(namePart)}" />
                    <h:outputText value="(#{namePart.fullName})"
                                  styleClass="#{requestManager.getNameClass(namePart)}-Old"
                                  rendered="#{requestManager.isModified(namePart)}" />
                </p:column>
                <p:column id="nameCode" headerText="Name" filterBy="#{namePart.name}" filterMatchMode="startsWith"
                          style="width: 10%">
                    <h:outputText value="#{requestManager.getNewName(namePart)}"
                                  styleClass="#{requestManager.getNameClass(namePart)}-New" />
                    <h:outputText value=" " rendered="#{requestManager.isModified(namePart)}" />
                    <h:outputText value="(#{namePart.name})"
                                  styleClass="#{requestManager.getNameClass(namePart)}-Old"
                                  rendered="#{requestManager.isModified(namePart)}" />
                </p:column>
                <p:column id="status" headerText="Status" style="width: 15%">
                    <h:outputText value="#{namesManager.nameStatus(namePart.nameEvent)}"
                                  styleClass="#{requestManager.getNameClass(namePart)}" />
                </p:column>

            </p:treeTable>

            <ui:include src="/WEB-INF/includes/part-history.xhtml" >
                <ui:param name="historyHandler" value="#{requestManager.historyEvents}" />
            </ui:include>
        </h:form>

        <!-- ===================Add Form================================= -->
        <h:form id="addNameForm" >
            <p:dialog id="addName"  widgetVar="addName">
                <f:facet name="header">
                    <h:outputText value="Request to Add Name"/>
                </f:facet>
                <p:panelGrid columns="2" style="text-align: left">
                    <h:outputLabel for="icode" value="Name:" />
                    <h:inputText id="icode" value="#{requestManager.newCode}" required="true"  label="Short identifier for the name" />

                    <h:outputLabel for="idesc" value="Full Name:" />
                    <p:inputText id="idesc" value="#{requestManager.newDescription}" required="true"  label="A description of the name"/>

                    <h:outputLabel for="icomm" value="Comment:" />
                    <p:inputTextarea id="icomm" rows="5" cols="60" counter="icounter" maxlength="254"
                                     value="#{requestManager.newComment}"
                                     counterTemplate="{0} characters remaining." autoResize="false"
                                     required="true"  label="Why you want to add this name?" />
                </p:panelGrid>
                <h:outputText id="icounter" />
                <p:watermark for="icode" value="Enter Code" />
                <p:watermark for="idesc" value="Enter Description" />
                <p:watermark for="icomm" value="Why you want to add this name?" />
                <p:separator />

                <p:commandButton value="Submit" style="float: left"
                                 update=":ReqSubForm"
                                 oncomplete="addName.hide()"
                                 action="#{requestManager.onAdd()}"/>
                <p:commandButton  value="Cancel" style="float: right"
                                  onclick="addName.hide()"  />
            </p:dialog>
        </h:form>

        <!-- ===================Modify Form================================= -->
        <h:form id="ModNameForm" >
            <p:dialog id="modName" widgetVar="modName">
                <f:facet name="header">
                    <h:outputText value="Request to Change Name"/>
                </f:facet>
                <p:panelGrid id="pgrid" style="text-align: left">
                    <f:facet name="header">
                        <p:row>
                            <p:column><h:outputText value="" /></p:column>
                            <p:column><h:outputText value="Current Value" /></p:column>
                            <p:column><h:outputText value="New Value" /></p:column>
                        </p:row>
                    </f:facet>

                    <p:row>
                        <p:column><h:outputLabel for="mcode" value="Name:" /> </p:column>
                        <p:column><h:outputText value="#{requestManager.selectedName.name}" /></p:column>
                        <p:column><p:inputText id="mcode" value="#{requestManager.newCode}" required="true" /></p:column>
                    </p:row>
                    <p:row>
                        <p:column><h:outputLabel for="mdesc" value="Full name:" /></p:column>
                        <p:column><h:outputText value="#{requestManager.selectedName.fullName}"/></p:column>
                        <p:column><p:inputText id="mdesc" value="#{requestManager.newDescription}" required="true" /></p:column>
                    </p:row>
                    <p:row>
                        <p:column><h:outputLabel for="mcomm" value="Comment:" /></p:column>
                        <p:column colspan="2" >
                            <p:inputTextarea id="mcomm"  counter="mcounter" maxlength="254"
                                             value="#{requestManager.newComment}"
                                             rows="5" cols="60"
                                             counterTemplate="{0} characters remaining."
                                             required="true"  label="Please justify why you want to change this name."
                                             autoResize="false"/>
                            <br/>
                            <h:outputText id="mcounter" />
                        </p:column>
                    </p:row>

                </p:panelGrid>
                <p:watermark for="mcomm" value="Why do you want to change this name?" />
                <p:separator />

                <p:commandButton value="Submit" style="float: left"
                                 update=":ReqSubForm"
                                 oncomplete="modName.hide()"
                                 action="#{requestManager.onModify()}"/>
                <p:commandButton  value="Cancel" style="float: right"
                                  onclick="modName.hide()"  />
            </p:dialog>
        </h:form>

        <!-- ===================Delete Form================================= -->
        <h:form id="DelNameForm" >
            <p:dialog id="delName"  widgetVar="delName">
                <f:facet name="header">
                    <h:outputText value="Request to Delete/Retire Names"/>
                </f:facet>
                <p:panelGrid id="pgrid" style="text-align: left">

                    <p:row>
                        <p:column colspan="2" rendered="#{requestManager.deleteNames}">
                            <p:tree value="#{requestManager.deleteCandidates}" var="candidate" style="width: 100%; height: 150px;">
                                <p:treeNode>
                                    <h:outputText styleClass="#{candidate.delete ? 'Processing Delete-Processing' : ''}"
                                                  value="#{candidate.fullName} (#{candidate.name})" />
                                </p:treeNode>
                            </p:tree>
                        </p:column>
                        <p:column colspan="2" rendered="#{!requestManager.deleteNames}">
                            <h:outputText value="No deletable element selected." />
                        </p:column>
                    </p:row>

                    <p:row>
                        <p:column>
                            <h:outputLabel for="dcomm" value="Comment:" />
                        </p:column>
                        <p:column>
                            <p:inputTextarea id="dcomm" rows="5" cols="40" counter="dcounter" maxlength="254"
                                             value="#{requestManager.newComment}"
                                             counterTemplate="{0} characters remaining."
                                             required="true" label="Please justify why you want to delete this name."
                                             autoResize="false"/>
                        </p:column>
                        <h:outputText id="dcounter" />
                        <p:watermark for="dcomm" value="Why do you want to delete this name?" />
                    </p:row>
                </p:panelGrid>
                <p:separator />

                <p:commandButton value="Submit" style="float: left"
                                 update=":ReqSubForm" disabled="#{!requestManager.deleteNames}"
                                 oncomplete="delName.hide()"
                                 action="#{requestManager.onDelete()}"/>
                <p:commandButton  value="Cancel" style="float: right"
                                  onclick="delName.hide()"  />
            </p:dialog>
        </h:form>

        <!-- ===================Cancel Form    ============================ -->
        <h:form id="CancelReqForm" >
            <p:dialog id="cancelReq"  widgetVar="cancelReq">
                <f:facet name="header">
                    <h:outputText value="Cancel Request"/>
                </f:facet>
                <p:panelGrid id="pgrid" columns="2" style="text-align: left">
                    <h:outputText  value="Category:" />
                    <h:outputText value="#{requestManager.selectedName.nameCategory}" />

                    <h:outputText value="Code:" />
                    <h:outputText value="#{requestManager.selectedName.name}" />

                    <h:outputText value="Description:" />
                    <h:outputText value="#{requestManager.selectedName.fullName}"/>

                    <h:outputLabel for="ccomm" value="Comment:" />
                    <p:inputTextarea id="ccomm" rows="5" cols="40" counter="ccounter" maxlength="254"
                                     value="#{requestManager.newComment}"
                                     counterTemplate="{0} characters remaining."
                                     required="true"  label="Please justify why you want to cancel this request."
                                     autoResize="false"/>
                    <h:outputText id="ccounter" />
                    <p:watermark for="ccomm" value="Why do you want to cancel this request?" />
                </p:panelGrid>
                <p:separator />

                <p:commandButton value="Submit" style="float: left"
                                 update=":ReqSubForm"
                                 oncomplete="cancelReq.hide()"
                                 action="#{requestManager.onCancel()}"/>
                <p:commandButton  value="Cancel" style="float: right"
                                  onclick="delName.hide()"  />
            </p:dialog>

        </h:form>
    </ui:define>
</ui:composition>