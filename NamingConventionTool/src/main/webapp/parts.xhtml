<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
	template="/WEB-INF/namesTemplate.xhtml"
	xmlns:p="http://primefaces.org/ui"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html">
	<ui:define name="content">
		<ui:fragment rendered="#{userManager.isLoggedIn()}">
			<!-- =================== Req Sub Form ================================= -->
			<h:form id="ReqSubForm">
				<p:growl globalOnly="true" id="partsMsgs" showDetail="true"
					sticky="false" life="30000" escape="false" />
				<!-- =================== Menus      ============================ -->
				<div id="filterTable">
					<p:panelGrid style="width:100%; padding:5px 0px 5px 0px; border-type:none;" >
						<p:row>
							<p:column >
								<p:outputLabel for="filterMenu" value="Show: " />
								<p:selectOneMenu value="#{namePartsController.viewFilter}"
									id="filterMenu">
									<p:ajax listener="#{namePartsController.modifyDisplayView}"
										event="change" update="namePartsTree reqMenu"
										oncomplete="resizePanel()" />
									<f:selectItem itemLabel="Approved and Proposed"
										itemValue="APPROVED_AND_PROPOSED" />
									<f:selectItem itemLabel="Approved" itemValue="APPROVED" />
									<f:selectItem itemLabel="Proposed" itemValue="PROPOSED" />
									<f:selectItem itemLabel="Archived" itemValue="ARCHIVED" />
								</p:selectOneMenu>
							</p:column>
							<p:column>
								<p:menuButton value="Actions" id="reqMenu" style="z-index: 100; float:right">
									<p:menuitem value="Add"
										actionListener="#{namePartsController.prepareAddPopup()}"
										title="Add Name" icon="ui-icon-plus"
										oncomplete="addName.show()" update=":addNameForm:addName"
										disabled="#{!(namePartsController.canAdd())}"
										rendered="#{userManager.editor}" />
									<p:menuitem value="Delete"
										actionListener="#{namePartsController.prepareDeletePopup()}"
										title="Delete Name" icon="ui-icon-trash"
										update=":DelNameForm:delName" oncomplete="delName.show()"
										disabled="#{!(namePartsController.canDelete())}"
										rendered="#{userManager.editor}" />
									<p:menuitem value="Modify"
										actionListener="#{namePartsController.prepareModifyPopup()}"
										title="Modify Name" icon="ui-icon-pencil"
										update=":ModNameForm:modName" oncomplete="modName.show()"
										disabled="#{!(namePartsController.canModify())}"
										rendered="#{userManager.editor}" />
									<p:menuitem value="Approve"
										actionListener="#{namePartsController.prepareApprovePopup()}"
										title="Approve Request" icon="ui-icon-check"
										update=":ApproveForm" oncomplete="approveRequest.show()"
										disabled="#{!(namePartsController.canApprove())}"
										rendered="#{userManager.superUser}" />
									<p:menuitem value="Reject" title="Reject Request"
										icon="ui-icon-close" update=":RejectForm"
										oncomplete="rejectRequest.show()"
										disabled="#{!(namePartsController.canCancel())}"
										rendered="#{userManager.superUser}" />
									<p:menuitem value="Cancel" title="Cancel changes"
										icon="ui-icon-close" update=":CancelReqForm:cancelReq"
										oncomplete="cancelReq.show()"
										disabled="#{!(namePartsController.canCancel())}"
										rendered="#{userManager.editor and !userManager.superUser}" />
									<p:menuitem value="History" title="View History"
										icon="ui-icon-search"
										actionListener="#{namePartsController.prepareHistoryPopup()}"
										update=":ReqSubForm:historyTable"
										oncomplete="nameDetail.show()"
										disabled="#{!(namePartsController.canShowHistory())}" />
								</p:menuButton>
							</p:column>
						</p:row>
					</p:panelGrid>
				</div>

				<!-- =================== Tree Table ================================= -->
	
				<ui:include src="/WEB-INF/includes/parts-treetable.xhtml">
					<ui:param name="treeId" value="namePartsTree" />
					<ui:param name="view" value="#{namePartsController.viewRoot}" />
					<ui:param name="selectionMode" value="multiple" />
					<ui:param name="update" value=":ReqSubForm:reqMenu" />
				</ui:include>

				<!-- =================== History ================================= -->
				<ui:include src="/WEB-INF/includes/parts-history.xhtml">
					<ui:param name="historyHandler"
						value="#{namePartsController.historyRevisions}" />
				</ui:include>
			</h:form>

			<!-- ===================Add Form================================= -->
			<ui:include src="/WEB-INF/includes/parts-wizard.xhtml">
				<ui:param name="formId" value="addNameForm" />
				<ui:param name="widgetId" value="addName" />
				<ui:param name="widgetTitle" value="Request to Add name element" />
				<ui:param name="gridId" value="grid" />
				<ui:param name="fullName" value="#{namePartsController.formName}" />
				<ui:param name="validator" value="custom.addMnemonicValidator" />
				<ui:param name="warning" value="displayMnemonicLengthWarningOnAdd()" />
				<ui:param name="mnemonic"
					value="#{namePartsController.formMnemonic}" />
				<ui:param name="description"
					value="#{namePartsController.formDescription}" />
				<ui:param name="comment" value="#{namePartsController.formComment}" />
				<ui:param name="description"
					value="#{namePartsController.formDescription}" />
				<ui:param name="submitHandler" value="onAdd" />
			</ui:include>

			<!-- ===================Modify Form================================= -->
			<ui:include src="WEB-INF/includes/parts-wizard.xhtml">
				<ui:param name="formId" value="ModNameForm" />
				<ui:param name="widgetId" value="modName" />
				<ui:param name="gridId" value="pgrid" />
				<ui:param name="widgetTitle" value="Request to Change Name" />
				<ui:param name="fullName" value="#{namePartsController.formName}" />
				<ui:param name="mnemonic"
					value="#{namePartsController.formMnemonic}" />
				<ui:param name="validator" value="custom.modifyMnemonicValidator" />
				<ui:param name="warning" value="displayMnemonicLengthWarningOnMod()" />
				<ui:param name="description"
					value="#{namePartsController.formDescription}" />
				<ui:param name="comment" value="#{namePartsController.formComment}" />
				<ui:param name="submitHandler" value="onModify" />
			</ui:include>

			<!-- ===================Delete Form================================= -->
			<h:form id="DelNameForm">
				<p:dialog header="Request to Delete" id="delName"
					widgetVar="delName" modal="true" resizable="true">
					<p:treeTable value="#{namePartsController.deleteView}"
						var="candidate" resizableColumns="true" liveResize="true"
						styleClass="previewTreeTable">
						<p:column headerText="Full Name" style="width:25%">
							<h:outputText
								styleClass="#{candidate.affected ? 'Pending-deletion' : ''}"
								value="#{candidate.data.name}" />
						</p:column>
						<p:column headerText="Mnemonic" style="width:10%">
							<h:outputText
								styleClass="#{candidate.affected ? 'Pending-deletion' : ''}"
								value="#{candidate.data.mnemonic}" />
						</p:column>
						<p:column headerText="Description/Comment">
							<h:outputText
								styleClass="#{candidate.affected ? 'Pending-deletion' : ''}"
								value="#{candidate.data.description}" />
						</p:column>
					</p:treeTable>
					<p:separator />
					<h:panelGrid id="pgrid" style="text-align: left">
						<h:outputLabel for="dcomm" value="Commit Message (optional):" />
						<h:panelGroup>
							<p:inputTextarea id="dcomm" rows="5" cols="60" counter="dcounter"
								maxlength="254" value="#{namePartsController.formComment}"
								counterTemplate="{0} characters remaining." autoResize="false" />
							<br />
							<h:outputText id="dcounter" />
						</h:panelGroup>
						<h:panelGroup style="margin: 10px 0; padding: 10px"
							styleClass="ui-message-warn ui-corner-all" layout="block"
							rendered="#{namePartsController.affectedDevicesCount > 0}">
							<span class="ui-message-warn-icon" />
							<h:panelGroup class="ui-message-warn-detail">
								<h:outputText
									value="Warning: There are #{namePartsController.affectedDevicesCount} dependent devices that will be deleted once the change has been approved." />
							</h:panelGroup>
						</h:panelGroup>
					</h:panelGrid>

					<p:separator />

					<p:commandButton value="Cancel" style="float: right"
						onclick="delName.hide()" />
					<p:commandButton value="Submit" style="float: right"
						oncomplete="delName.hide();resizePanel()" update=":ReqSubForm"
						actionListener="#{namePartsController.onDelete()}" />
				</p:dialog>
			</h:form>

			<!-- =================== Cancel Form ============================ -->
			<h:form id="CancelReqForm">
				<p:dialog header="Cancel proposals, modifications and/or deletions"
					id="cancelReq" widgetVar="cancelReq" modal="true" resizable="true">
					<p:treeTable value="#{namePartsController.cancelView}"
						var="candidate" resizableColumns="true" liveResize="true"
						styleClass="previewTreeTable">
						<p:column headerText="Full Name" style="width:25%">
							<h:outputText
								styleClass="#{namePartsController.isNameModified(candidate.data) ? 'Cancel-proposed' : namePartsController.nameCancelStyleClass(candidate.data)}"
								value="#{namePartsController.getOperationsNewName(candidate)}" />
							<h:outputText value=" "
								rendered="#{namePartsController.isNameModified(candidate.data)}" />
							<h:outputText value="#{candidate.data.name}"
								styleClass="Cancel-pending-deletion"
								rendered="#{namePartsController.isNameModified(candidate.data)}" />
						</p:column>
						<p:column headerText="Mnemonic" style="width: 10%">
							<h:outputText
								value="#{namePartsController.getNewMnemonic(candidate.data)}"
								styleClass="#{namePartsController.isMnemonicModified(candidate.data) ? 'Cancel-proposed' : namePartsController.nameCancelStyleClass(candidate.data)}" />
							<h:outputText value=" "
								rendered="#{namePartsController.isMnemonicModified(candidate.data)}" />
							<h:outputText value="#{candidate.data.mnemonic}"
								styleClass="Cancel-pending-deletion"
								rendered="#{namePartsController.isMnemonicModified(candidate.data)}" />
						</p:column>
						<p:column headerText="Description/Comment">
							<h:outputText
								value="#{namePartsController.getNewDescription(candidate.data)}"
								styleClass="#{namePartsController.isDescriptionModified(candidate.data) ? 'Cancel-proposed' : namePartsController.nameCancelStyleClass(candidate.data)}" />
							<h:outputText value=" "
								rendered="#{namePartsController.isDescriptionModified(candidate.data)}" />
							<h:outputText value="#{candidate.data.description}"
								styleClass="Cancel-pending-deletion"
								rendered="#{namePartsController.isDescriptionModified(candidate.data)}" />
						</p:column>
					</p:treeTable>
					<p:separator />

					<h:panelGrid id="pgrid" style="text-align: left">
						<h:outputLabel for="dcomm" value="Commit Message (optional):" />
						<h:panelGroup>
							<p:inputTextarea id="dcomm" rows="5" cols="60" counter="dcounter"
								maxlength="254" value="#{namePartsController.formComment}"
								counterTemplate="{0} characters remaining." autoResize="false" />
							<br />
							<h:outputText id="dcounter" />
						</h:panelGroup>
					</h:panelGrid>
					<p:separator />
					<p:commandButton value="Cancel" style="float: right"
						onclick="cancelReq.hide()" />
					<p:commandButton value="Submit" style="float: right"
						update=":ReqSubForm" oncomplete="cancelReq.hide();resizePanel()"
						actionListener="#{namePartsController.onCancel()}" />
				</p:dialog>
			</h:form>
			<!-- ===================    Approve Form    ============================ -->

			<h:form id="ApproveForm">
				<p:dialog header="Approve proposals, modifications and/or deletions"
					id="approveRequest" widgetVar="approveRequest" modal="true"
					resizable="true">
					<p:treeTable value="#{namePartsController.approveView}"
						var="candidate" liveResize="true" resizableColumns="true"
						styleClass="previewTreeTable">
						<p:column headerText="Full Name" style="width:25%">
							<h:outputText
								styleClass="#{namePartsController.isNameModified(candidate.data) ? 'Proposed' : namePartsController.nameStyleClass(candidate.data)}"
								value="#{namePartsController.getOperationsNewName(candidate)}" />
							<h:outputText value=" "
								rendered="#{namePartsController.isNameModified(candidate.data)}" />
							<h:outputText value="#{candidate.data.name}"
								styleClass="Pending-deletion"
								rendered="#{namePartsController.isNameModified(candidate.data)}" />
						</p:column>
						<p:column headerText="Mnemonic" style="width: 10%">
							<h:outputText
								value="#{namePartsController.getNewMnemonic(candidate.data)}"
								styleClass="#{namePartsController.isMnemonicModified(candidate.data) ? 'Proposed' : namePartsController.nameStyleClass(candidate.data)}" />
							<h:outputText value=" "
								rendered="#{namePartsController.isMnemonicModified(candidate.data)}" />
							<h:outputText value="#{candidate.data.mnemonic}"
								styleClass="Pending-deletion"
								rendered="#{namePartsController.isMnemonicModified(candidate.data)}" />
						</p:column>
						<p:column headerText="Description/Comment">
							<h:outputText
								value="#{namePartsController.getNewDescription(candidate.data)}"
								styleClass="#{namePartsController.isDescriptionModified(candidate.data) ? 'Proposed' : namePartsController.nameStyleClass(candidate.data)}" />
							<h:outputText value=" "
								rendered="#{namePartsController.isDescriptionModified(candidate.data)}" />
							<h:outputText value="#{candidate.data.description}"
								styleClass="Pending-deletion"
								rendered="#{namePartsController.isDescriptionModified(candidate.data)}" />
						</p:column>
					</p:treeTable>
					<p:separator />
					<h:panelGrid style="text-align: left">
						<h:outputLabel for="acomm" value="Comment (optional):" />
						<h:panelGroup>
							<p:inputTextarea id="acomm" rows="5" cols="60" counter="counter"
								maxlength="254" value="#{namePartsController.formComment}"
								counterTemplate="{0} characters remaining." autoResize="false" />
							<br />
							<h:outputText id="counter" />
						</h:panelGroup>
						<h:panelGroup style="margin: 10px 0; padding: 10px"
							styleClass="ui-message-warn ui-corner-all" layout="block"
							rendered="#{namePartsController.affectedDevicesCount > 0}">
							<span class="ui-message-warn-icon" />
							<h:panelGroup class="ui-message-warn-detail">
								<h:outputText
									value="Warning: There are #{namePartsController.affectedDevicesCount} dependent devices that will be deleted by this action!" />
							</h:panelGroup>
						</h:panelGroup>
					</h:panelGrid>
					<p:separator />
					<p:commandButton value="Cancel" style="float: right"
						onclick="approveRequest.hide()" />
					<p:commandButton value="Approve" style="float: right"
						update=":ReqSubForm"
						oncomplete="approveRequest.hide();resizePanel()"
						actionListener="#{namePartsController.onApprove()}" />
				</p:dialog>
			</h:form>

			<h:form id="RejectForm">
				<p:dialog header="Reject proposals, modifications and/or deletions"
					id="rejectRequest" widgetVar="rejectRequest" modal="true"
					resizable="true">
					<p:treeTable value="#{namePartsController.cancelView}"
						var="candidate" liveResize="true" resizableColumns="true"
						styleClass="previewTreeTable">
						<p:column headerText="Full Name" style="width: 25%">
							<h:outputText
								styleClass="#{namePartsController.isNameModified(candidate.data) ? 'Cancel-proposed' : namePartsController.nameCancelStyleClass(candidate.data)}"
								value="#{namePartsController.getOperationsNewName(candidate)}" />
							<h:outputText value=" "
								rendered="#{namePartsController.isNameModified(candidate.data)}" />
							<h:outputText value="#{candidate.data.name}"
								styleClass="Cancel-pending-deletion"
								rendered="#{namePartsController.isNameModified(candidate.data)}" />
						</p:column>
						<p:column headerText="Mnemonic" style="width: 10%">
							<h:outputText
								value="#{namePartsController.getNewMnemonic(candidate.data)}"
								styleClass="#{namePartsController.isMnemonicModified(candidate.data) ? 'Cancel-proposed' : namePartsController.nameCancelStyleClass(candidate.data)}" />
							<h:outputText value=" "
								rendered="#{namePartsController.isMnemonicModified(candidate.data)}" />
							<h:outputText value="#{candidate.data.mnemonic}"
								styleClass="Cancel-pending-deletion"
								rendered="#{namePartsController.isMnemonicModified(candidate.data)}" />
						</p:column>
						<p:column headerText="Description/Comment">
							<h:outputText
								value="#{namePartsController.getNewDescription(candidate.data)}"
								styleClass="#{namePartsController.isDescriptionModified(candidate.data) ? 'Cancel-proposed' : namePartsController.nameCancelStyleClass(candidate.data)}" />
							<h:outputText value=" "
								rendered="#{namePartsController.isDescriptionModified(candidate.data)}" />
							<h:outputText value="#{candidate.data.description}"
								styleClass="Cancel-pending-deletion"
								rendered="#{namePartsController.isDescriptionModified(candidate.data)}" />
						</p:column>
					</p:treeTable>
					<p:separator />

					<h:panelGrid id="pgrid" style="text-align: left">
						<h:outputLabel for="rcomm" value="Comment:" />
						<h:panelGroup>
							<p:inputTextarea id="rcomm" rows="5" cols="70" counter="counter"
								maxlength="254" value="#{namePartsController.formComment}"
								counterTemplate="{0} characters remaining." autoResize="false"
								required="true" requiredMessage="Please enter a comment." />
							<br />
							<h:outputText id="counter" />
							<p:message for="rcomm" />
						</h:panelGroup>
					</h:panelGrid>
					<p:separator />
					<p:commandButton value="Cancel" style="float: right"
						onclick="rejectRequest.hide()" />
					<p:commandButton value="Reject" style="float: right"
						update="pgrid :ReqSubForm"
						oncomplete="if (args &amp;&amp; !args.validationFailed) rejectRequest.hide(); resizePanel()"
						action="#{namePartsController.onReject()}" />
				</p:dialog>
			</h:form>
		</ui:fragment>
	</ui:define>
</ui:composition>